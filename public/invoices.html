<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Invoice List</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { padding: 10px; border: 1px solid #ccc; text-align: left; }
    input[type="text"] { padding: 8px; width: 300px; margin-bottom: 10px; }
    .pagination { margin-top: 15px; }
    .pagination button { padding: 6px 12px; margin-right: 5px; }
    .pagination button:disabled { background-color: #ccc; }
  </style>
</head>
<body>
  <h1>Saved Invoices</h1>

  <!-- Search input -->
  <input type="text" id="searchInput" placeholder="Search by invoice # or client name" />

  <!-- Table for invoice data -->
  <table id="invoiceTable">
    <thead>
      <tr>
        <th>Invoice #</th>
        <th>Date</th>
        <th>Client</th>
        <th>Total</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Pagination controls -->
  <div class="pagination" id="pagination"></div>

  <script>
    let invoices = [];
    let currentPage = 1;
    const itemsPerPage = 5;

    function escapeHTML(str) {
      return str?.replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;") || '';
    }

    function fetchInvoices() {
      fetch('/invoices')
        .then(res => {
          if (!res.ok) throw new Error("Network response was not ok");
          return res.json();
        })
        .then(data => {
          invoices = data;
          renderTable();
        })
        .catch(err => {
          console.error("Failed to fetch invoices:", err);
          alert("Failed to load invoices. Please try again later.");
        });
    }

    function renderTable() {
      const search = document.getElementById('searchInput').value.toLowerCase();

      const filtered = invoices.filter(inv =>
        (inv.invoice_number ?? '').toLowerCase().includes(search) ||
        (inv.bill_to ?? '').toLowerCase().includes(search)
      );

      // Pagination fix
      const maxPage = Math.ceil(filtered.length / itemsPerPage);
      if (currentPage > maxPage) currentPage = maxPage || 1;

      const start = (currentPage - 1) * itemsPerPage;
      const paginated = filtered.slice(start, start + itemsPerPage);

      const tableBody = document.querySelector("#invoiceTable tbody");
      tableBody.innerHTML = "";

      if (paginated.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="5" style="text-align:center;">No invoices found</td></tr>`;
        renderPagination(filtered.length);
        return;
      }

      paginated.forEach(invoice => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${escapeHTML(invoice.invoice_number ?? 'N/A')}</td>
          <td>${escapeHTML(invoice.invoice_date ?? 'N/A')}</td>
          <td>${escapeHTML(invoice.bill_to ?? 'N/A')}</td>
          <td>â‚±${(invoice.total_amount ?? 0).toFixed(2)}</td>
          <td>
            <button type="button" onclick="viewInvoice('${invoice.invoice_number}')" title="View this invoice">View</button>
            <button type="button" onclick="editInvoice('${invoice.invoice_number}')" title="Edit this invoice">Edit</button>
            <button type="button" onclick="deleteInvoice('${invoice.invoice_number}')" title="Delete this invoice">Delete</button>
            <button type="button" onclick="printInvoice('${invoice.invoice_number}')" title="Print this invoice">Print</button>
          </td>
        `;
        tableBody.appendChild(row);
      });

      renderPagination(filtered.length);
    }

    function renderPagination(totalItems) {
      const pageCount = Math.ceil(totalItems / itemsPerPage);
      const pagination = document.getElementById("pagination");
      pagination.innerHTML = "";

      for (let i = 1; i <= pageCount; i++) {
        const btn = document.createElement("button");
        btn.textContent = i;
        btn.type = "button";
        btn.disabled = (i === currentPage);
        btn.onclick = () => {
          currentPage = i;
          renderTable();
        };
        pagination.appendChild(btn);
      }
    }

    function viewInvoice(id) {
      window.location.href = `/PRINTABLE/Replica.html?id=${encodeURIComponent(id)}`;
    }

    function editInvoice(id) {
      window.location.href = `/edit-invoice.html?id=${encodeURIComponent(id)}`;
    }

    function deleteInvoice(id) {
      if (confirm("Are you sure you want to delete this invoice?")) {
        fetch(`/invoice/${encodeURIComponent(id)}`, { method: "DELETE" })
          .then(res => {
            if (!res.ok) throw new Error("Delete failed");
            fetchInvoices();
          })
          .catch(err => {
            console.error("Failed to delete invoice:", err);
            alert("Failed to delete invoice. Please try again.");
          });
      }
    }

    function printInvoice(id) {
      window.open(`/PRINTABLE/Replica.html?id=${encodeURIComponent(id)}`, '_blank');
    }

    document.getElementById('searchInput').addEventListener('input', () => {
      currentPage = 1;
      renderTable();
    });

    fetchInvoices();
  </script>
</body>
</html>
