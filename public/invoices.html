<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Invoice List</title>
  <style>
    /* Basic page styling */
    body { font-family: Arial, sans-serif; padding: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { padding: 10px; border: 1px solid #ccc; text-align: left; }
    input[type="text"] { padding: 8px; width: 300px; margin-bottom: 10px; }
    .pagination { margin-top: 15px; }
    .pagination button { padding: 6px 12px; margin-right: 5px; }
  </style>
</head>
<body>
  <h1>Saved Invoices</h1>

  <!-- Search input to filter invoices by invoice number or client name -->
  <input type="text" id="searchInput" placeholder="Search by invoice # or client name" />

  <!-- Table to display invoices -->
  <table id="invoiceTable">
    <thead>
      <tr>
        <th>Invoice #</th>
        <th>Date</th>
        <th>Client</th>
        <th>Total</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody> <!-- Table body where invoice rows will be added dynamically -->
  </table>

  <!-- Pagination buttons container -->
  <div class="pagination" id="pagination"></div>

  <script>
    // Store fetched invoices here
    let invoices = [];
    // Current page in pagination
    let currentPage = 1;
    // Number of items per page
    const itemsPerPage = 5;

    // Fetch invoices from backend API
    function fetchInvoices() {
      fetch('/invoices')
        .then(res => res.json())
        .then(data => {
          invoices = data; // Store data
          renderTable();   // Render the table after fetching
        });
    }

    // Render invoice table rows based on current page and search filter
    function renderTable() {
      // Get search input value and convert to lowercase for case-insensitive filtering
      const search = document.getElementById('searchInput').value.toLowerCase();

      // Filter invoices by invoice number or client name matching the search text
      const filtered = invoices.filter(inv =>
        inv.invoice_number.toLowerCase().includes(search) ||
        inv.bill_to.toLowerCase().includes(search)
      );

      // Calculate start index of current page slice
      const start = (currentPage - 1) * itemsPerPage;
      // Slice filtered invoices for current page
      const paginated = filtered.slice(start, start + itemsPerPage);

      // Get reference to the table body
      const tableBody = document.querySelector("#invoiceTable tbody");
      // Clear previous rows
      tableBody.innerHTML = "";

      // Create a table row for each invoice in the current page
      paginated.forEach(invoice => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${invoice.invoice_number}</td>
          <td>${invoice.invoice_date}</td>
          <td>${invoice.bill_to}</td>
          <!-- Safely format total amount; show 0.00 if null or undefined -->
          <td>â‚±${(invoice.total_amount ?? 0).toFixed(2)}</td>
          <td>
            <!-- Action buttons for each invoice -->
            <button onclick="viewInvoice('${invoice.invoice_number}')">View</button>
            <button onclick="editInvoice('${invoice.invoice_number}')">Edit</button>
            <button onclick="deleteInvoice('${invoice.invoice_number}')">Delete</button>
            <button onclick="printInvoice('${invoice.invoice_number}')">Print</button>
          </td>
        `;
        // Add the row to the table body
        tableBody.appendChild(row);
      });

      // Render pagination buttons below the table
      renderPagination(filtered.length);
    }

    // Render pagination buttons dynamically based on total number of filtered invoices
    function renderPagination(totalItems) {
      const pageCount = Math.ceil(totalItems / itemsPerPage);
      const pagination = document.getElementById("pagination");
      // Clear existing buttons
      pagination.innerHTML = "";

      // Create a button for each page
      for (let i = 1; i <= pageCount; i++) {
        const btn = document.createElement("button");
        btn.textContent = i;
        // Disable the button for the current page
        if (i === currentPage) btn.disabled = true;
        // On click, update current page and rerender the table
        btn.onclick = () => {
          currentPage = i;
          renderTable();
        };
        pagination.appendChild(btn);
      }
    }

    // Navigate to the printable view of the invoice
    function viewInvoice(id) {
      window.location.href = `/PRINTABLE/Replica.html?id=${id}`;
    }

    // Navigate to the edit invoice page
    function editInvoice(id) {
      window.location.href = `/edit-invoice.html?id=${id}`;
    }

    // Delete an invoice with confirmation and then refresh the invoice list
    function deleteInvoice(id) {
      if (confirm("Are you sure you want to delete this invoice?")) {
        fetch(`/invoice/${id}`, { method: "DELETE" })
          .then(() => fetchInvoices()); // Refresh list after deletion
      }
    }

    // Open the printable invoice in a new browser tab
    function printInvoice(id) {
      window.open(`/PRINTABLE/Replica.html?id=${id}`, '_blank');
    }

    // Attach event listener to search input to filter invoices in real-time
    document.getElementById('searchInput').addEventListener('input', () => {
      currentPage = 1; // Reset to first page on new search
      renderTable();
    });

    // Initial fetch and render of invoices when the page loads
    fetchInvoices();
  </script>
</body>
</html>
