<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Invoice Preview</title>

<style>
/* ===============================
   GLOBAL
================================ */
html, body {
  height: 100%;
  margin: 0;
  font-family: Arial, sans-serif;
  background: #2b2b2b;
  color: #111;
  overflow: auto; /* single scrollbar */
}

/* ===============================
   TOP BAR
   (keep your colors; you said no need for color change)
================================ */
.top-bar {
  position: fixed;
  top: 0; left: 0; right: 0;
  z-index: 2000;
  height: 56px;
  background: #6F75E2;
  color: #ffffff;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 16px;
  border-bottom: 1px solid rgba(0,0,0,0.15);
  overflow: visible; /* allow dropdown */
}

.top-bar .left, .top-bar .right {
  display: flex;
  align-items: center;
  gap: 10px;
}

.top-bar .title {
  font-weight: 700;
  font-size: 16px;
}

.top-bar button {
  border: none;
  background: none;
  cursor: pointer;
  font-size: 14px;
  color: inherit;
}

.btn-primary {
  background: #0078d4;
  color: #fff;
  padding: 6px 12px;
  border-radius: 4px;
  cursor: pointer;
  border: none;
}

/* ===============================
   EXPORT DROPDOWN
================================ */
.export-dropdown {
  position: relative;
  display: inline-block;
}

.export-toggle {
  background: #0078d4;
  color: #fff;
  padding: 6px 14px;
  border-radius: 4px;
  border: none;
  font-size: 14px;
  cursor: pointer;
}

.export-menu {
  display: none;
  position: absolute;
  right: 0;
  top: calc(100% + 8px);
  background: #ffffff;
  color: #000;
  min-width: 180px;
  border-radius: 6px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.25);
  z-index: 3000;
  overflow: hidden;
}

.export-menu div {
  padding: 10px 14px;
  cursor: pointer;
  font-size: 14px;
  white-space: nowrap;
}

.export-menu div:hover {
  background: #f1f1f1;
}

.export-menu.show {
  display: block;
}

/* ===============================
   VIEWER (PDF in iframe)
   ✅ We remove the custom toolbar + transforms
   ✅ Chrome PDF Viewer toolbar will appear automatically
================================ */
.viewer {
  display: flex;
  justify-content: center;
  padding: 72px 0 16px 0; /* top bar only */
}

.page-container {
  width: min(1100px, calc(100vw - 24px));
  height: calc(100vh - 56px - 32px);
  background: transparent;
  box-shadow: 0 0 18px rgba(0,0,0,.55);
  border-radius: 2px;
  overflow: hidden; /* keeps the embedded PDF viewer clean */
}

iframe {
  width: 100%;
  height: 100%;
  border: none;
  background: transparent;
}

/* ===============================
   PRINT CLEAN
   (printing an iframe PDF uses browser PDF print anyway,
    but we keep your rule for safety)
================================ */
@media print {
  body { background: #fff; }
  .top-bar, .export-menu, .btn-primary { display: none !important; }
  .page-container { box-shadow: none !important; width: 100%; height: auto; }
}
</style>
</head>

<body>

<!-- =================== TOP BAR =================== -->
<div class="top-bar">
  <div class="left">
    <button onclick="closePreview()" aria-label="Close">✕</button>
    <span class="title">Invoice preview</span>
  </div>

  <div class="right">
    <button onclick="openSettings()">Invoice settings</button>

    <div class="export-dropdown">
      <button class="btn-primary export-toggle" onclick="toggleExportMenu()">
        Export ▾
      </button>

      <div class="export-menu" id="exportMenu">
        <div onclick="downloadPDF()">Download PDF</div>
        <div onclick="printPDF()">Print</div>
        <div onclick="exportExcel()">Export to Excel (.xlsx)</div>
      </div>
    </div>

    <button class="more-btn" aria-label="More">⋮</button>
  </div>
</div>

<!-- =================== VIEWER =================== -->
<div class="viewer">
  <div class="page-container">
    <iframe id="pdfFrame" title="PDF Preview"></iframe>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>

<script>
/* ===============================
   HELPERS
================================ */
const frame = document.getElementById('pdfFrame');

function closePreview() {
  if (window.opener) window.close();
  else if (document.referrer) window.history.back();
  else window.location.href = '/invoice-list.html';
}

function openSettings() { alert('Invoice settings (future)'); }

/* ===============================
   EXPORT DROPDOWN TOGGLE
================================ */
function toggleExportMenu() {
  document.getElementById('exportMenu')?.classList.toggle('show');
}

window.addEventListener('click', function (e) {
  const dropdown = document.querySelector('.export-dropdown');
  if (dropdown && !dropdown.contains(e.target)) {
    document.getElementById('exportMenu')?.classList.remove('show');
  }
});

/* ===============================
   LOAD PDF IN IFRAME (PUPPETEER GENERATED)
   ✅ This is what gives you the Chrome PDF viewer toolbar like your screenshot.
   Requires your backend route:
     GET /api/invoices/:invoiceNo/pdf
================================ */
const params = new URLSearchParams(window.location.search);
const invoiceNo = params.get('invoice_no');

if (!invoiceNo) {
  alert('No invoice number provided in the URL.');
  frame.src = '';
} else {
  const encodedInvoice = encodeURIComponent(invoiceNo.trim());
  // inline so iframe shows native viewer controls
  frame.src = `/api/invoices/${encodedInvoice}/pdf?disposition=inline&filename=${encodeURIComponent(`Invoice-${invoiceNo}.pdf`)}`;
}

/* ===============================
   ACTIONS (PDF)
================================ */
function printPDF() {
  // Works in most browsers; if cross-origin blocks, user can click print in the PDF toolbar
  try {
    frame.contentWindow.focus();
    frame.contentWindow.print();
  } catch (e) {
    alert('Use the Print button inside the PDF toolbar.');
  }
}

function downloadPDF() {
  if (!invoiceNo) return alert('Invoice number missing');
  const encodedInvoice = encodeURIComponent(invoiceNo.trim());
  // force download
  const url = `/api/invoices/${encodedInvoice}/pdf?disposition=attachment&filename=${encodeURIComponent(`Invoice-${invoiceNo}.pdf`)}`;
  window.open(url, '_blank');
}

/* ===============================
   EXPORT EXCEL (UNCHANGED)
================================ */
async function exportExcel() {
  if (!invoiceNo) {
    alert('Invoice number missing');
    return;
  }

  const res = await fetch(`/api/invoices/${encodeURIComponent(invoiceNo)}`);
  if (!res.ok) {
    alert('Invoice not found');
    return;
  }
  const inv = await res.json();

  const wb = new ExcelJS.Workbook();
  const ws = wb.addWorksheet('Invoice');

  ws.pageSetup = {
    paperSize: 9, // A4
    orientation: 'portrait',
    fitToPage: true,
    fitToWidth: 1,
    fitToHeight: 1,
    margins: { left: 0.5, right: 0.5, top: 0.75, bottom: 0.75 }
  };

  ws.columns = [
    { width: 4 },   // A
    { width: 14 },  // B
    { width: 18 },  // C
    { width: 10 },  // D
    { width: 10 },  // E
    { width: 10 },  // F
    { width: 10 },  // G
    { width: 10 },  // H
    { width: 12 },  // I
    { width: 14 }   // J
  ];

  let r = 1;

  ws.mergeCells(`A${r}:J${r}`);
  ws.getCell(`A${r}`).value = inv.company_name || '';
  ws.getCell(`A${r}`).font = { size: 16, bold: true };
  ws.getCell(`A${r}`).alignment = { horizontal: 'center' };
  r++;

  ws.mergeCells(`A${r}:J${r}`);
  ws.getCell(`A${r}`).value = inv.company_address || '';
  ws.getCell(`A${r}`).alignment = { horizontal: 'center' };
  r++;

  ws.mergeCells(`A${r}:J${r}`);
  ws.getCell(`A${r}`).value = `TIN: ${inv.company_tin || ''}`;
  ws.getCell(`A${r}`).alignment = { horizontal: 'center' };
  r += 2;

  ws.mergeCells(`A${r}:E${r}`);
  ws.mergeCells(`F${r}:J${r}`);
  ws.getCell(`A${r}`).value = 'BILL TO';
  ws.getCell(`F${r}`).value = 'SOLD TO';
  ws.getCell(`A${r}`).font = ws.getCell(`F${r}`).font = { bold: true };
  r++;

  ws.mergeCells(`A${r}:E${r}`);
  ws.mergeCells(`F${r}:J${r}`);
  ws.getCell(`A${r}`).value = inv.bill_to_name || '';
  ws.getCell(`F${r}`).value = inv.sold_to_name || '';
  r++;

  ws.mergeCells(`A${r}:E${r}`);
  ws.mergeCells(`F${r}:J${r}`);
  ws.getCell(`A${r}`).value = inv.bill_to_address || '';
  ws.getCell(`F${r}`).value = inv.sold_to_address || '';
  r += 2;

  const headerRow = ws.addRow(['#', 'Description', '', '', 'Qty', 'Unit', 'Price', '', 'Amount', '']);
  ws.mergeCells(`B${r}:D${r}`);
  ws.mergeCells(`H${r}:I${r}`);

  headerRow.eachCell(cell => {
    cell.font = { bold: true };
    cell.alignment = { horizontal: 'center' };
    cell.border = { top: { style: 'thin' }, bottom: { style: 'thin' } };
  });
  r++;

  (inv.items || []).forEach((item, i) => {
    const row = ws.addRow([
      i + 1,
      item.description || '', '', '',
      item.qty || '',
      item.unit || '',
      item.price || '',
      '',
      item.total || '',
      ''
    ]);

    ws.mergeCells(`B${r}:D${r}`);
    ws.mergeCells(`H${r}:I${r}`);

    row.eachCell(cell => {
      cell.border = { bottom: { style: 'hair' } };
    });

    r++;
  });

  r++;
  ws.mergeCells(`A${r}:H${r}`);
  ws.getCell(`A${r}`).value = 'TOTAL';
  ws.getCell(`A${r}`).alignment = { horizontal: 'right' };
  ws.getCell(`A${r}`).font = { bold: true };

  ws.mergeCells(`I${r}:J${r}`);
  ws.getCell(`I${r}`).value = inv.total_amount || inv.total_amount_due || '';
  ws.getCell(`I${r}`).font = { bold: true };
  ws.getCell(`I${r}`).alignment = { horizontal: 'right' };

  ws.getRow(r).eachCell(cell => {
    cell.border = { top: { style: 'thin' } };
  });

  ws.printTitlesRow = '1:1';
  ws.printArea = `A1:J${r + 2}`;

  const buffer = await wb.xlsx.writeBuffer();
  const blob = new Blob([buffer], {
    type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
  });

  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `Invoice-${invoiceNo}.xlsx`;
  link.click();
}
</script>

</body>
</html>
